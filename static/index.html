<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AIé©±åŠ¨çš„ç‰©ä½“è¯†åˆ«ä¸çŸ¥è¯†æŸ¥è¯¢å¹³å°">
    <title>BirdFinder - æ™ºèƒ½ç‰©ä½“è¯†åˆ«åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/landing.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">

    <script src="/static/tts.js"></script>
    <script src="/static/script.js"></script> <!-- æœ€åå¼•å…¥ä½ çš„ä¸»é€»è¾‘ -->
    <script src="/static/camera.js"></script>
</head>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<body>
<header class="app-header">
    <div class="header-content">
        <h1 aria-label="BirdFinder"><i class="ri-search-2-line"></i>BirdFinder</h1>

        <button class="menu-toggle" aria-label="èœå•">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <nav class="nav-container">
            <ul class="nav-links">
                <li><a href="/static/landing.html"><i class="ri-home-4-line"></i>ä¸»é¡µ</a></li>
                <li><a href="#" onclick="openPopup('historyPopup')"><i class="ri-history-line"></i>å†å²è®°å½•</a></li>
                <li><a href="#" onclick="openPopup('alertsPopup')"><i class="ri-alarm-warning-line"></i>å¼‚å¸¸é¢„è­¦</a></li>
                <li><a href="#" onclick="openPopup('dashboardPopup')"><i class="ri-dashboard-line"></i>æ•°æ®çœ‹æ¿</a></li>
                <li><a href="/static/about.html"><i class="ri-information-line"></i>å…³äºæˆ‘ä»¬</a></li>
            </ul>
            <button id="themeToggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
                <i class="ri-moon-line"></i>
            </button>
        </nav>
    </div>
</header>

<div class="overlay"></div>

<main class="main-container">
    <!-- æ™ºèƒ½è¯†åˆ«æ¨¡å— -->
    <section class="card upload-section" aria-labelledby="uploadHeading">
        <div class="section-header">
            <h2 id="uploadHeading"><span class="icon">ğŸ“¸</span> æ™ºèƒ½è¯†åˆ«</h2>
            <div class="input-group">
                <label for="imageUpload" class="custom-upload-btn">
                    ğŸ“ é€‰æ‹©å›¾ç‰‡
                    <input type="file" id="imageUpload" accept="image/*" hidden>
                </label>
                <label for="videoUpload" class="custom-upload-btn">
                    ğŸ¥ é€‰æ‹©è§†é¢‘
                    <input type="file" id="videoUpload" accept="video/*" hidden>
                </label>
                <button id="cameraBtn" class="custom-upload-btn">
                    ğŸ“¹ æ‰“å¼€ç›¸æœº
                </button>
            </div>
        </div>

        <div class="preview-container">
            <div class="image-preview" id="uploadPreview">
                <div class="placeholder-text">è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘è¿›è¡Œè¯†åˆ«</div>
            </div>
            <div class="processing-overlay" id="processing">
                <div class="loader"></div>
                <p>è¯†åˆ«å¤„ç†ä¸­...</p>
            </div>
        </div>
    </section>

    <section class="card result-section" aria-labelledby="resultHeading">
        <h2 id="resultHeading"><span class="icon">ğŸ”</span> æ£€æµ‹ç»“æœ</h2>
        <div class="result-grid">
            <div class="detected-objects">
                <h3>æ£€æµ‹åˆ°çš„ç‰©ä½“</h3>
                <ul id="detectedObjects" class="object-list">
                    <li class="placeholder-item">ç­‰å¾…è¯†åˆ«ç»“æœ...</li>
                </ul>
            </div>

            <div class="result-image-container">
                <div id="resultContainer" class="result-image">
                    <div class="placeholder-text">è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
            </div>
        </div>
    </section>

    <section class="card wiki-section" aria-labelledby="wikiInfoHeading">
        <h2 id="wikiInfoHeading"><span class="icon">ğŸ“–</span> é¸Ÿç±»ä»‹ç»</h2>
        <div id="wikiInfoContainer">
            <p>ç­‰å¾…è¯†åˆ«ç»“æœåæ˜¾ç¤ºç›¸å…³ä¿¡æ¯...</p>
        </div>
    </section>

    <section class="card chat-section" aria-labelledby="chatHeading">
        <h2 id="chatHeading"><span class="icon">ğŸ’¬</span> æ™ºèƒ½åŠ©æ‰‹</h2>
        <div class="chat-interface">
            <div class="chat-history" id="chatBox" role="log"></div>
            <div class="input-group">
                <input type="text" id="question"
                       placeholder="ä¾‹å¦‚ï¼šè¿™æ˜¯ä»€ä¹ˆé¸Ÿï¼Ÿ"
                       aria-label="é—®é¢˜è¾“å…¥"
                       data-gramm_editor="false">
                <button id="sendBtn" class="send-btn">
                    <span id="sendIcon" class="send-icon">ğŸš€</span>
                </button>
                <button id="recordBtn" class="record-btn">ğŸ¤</button>
            </div>
        </div>
    </section>
</main>

<!-- å†å²æ£€æµ‹è®°å½• å¼¹çª— -->
<div id="historyPopup" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closePopup('historyPopup')">&times;</span>
        <h2>ğŸ“œ å†å²æ£€æµ‹è®°å½•</h2>
        <div class="history-table">
            <table>
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æ£€æµ‹å¯¹è±¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- åŠ¨æ€æ’å…¥å†å²è®°å½• -->
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- å¼‚å¸¸é¢„è­¦å¼¹çª— -->
<div id="alertsPopup" class="popup">
    <div class="popup-content">
        <span class="close-btn" onclick="closePopup('alertsPopup')">&times;</span>
        <h2>å¼‚å¸¸é¢„è­¦è®¾ç½®</h2>

        <div class="alert-settings">
            <div class="setting-group">
                <h3>ç‰©ç§é¢„è­¦</h3>
                <div class="species-input-group">
                    <input type="text" id="speciesInput" placeholder="è¾“å…¥é¸Ÿç±»ç‰©ç§åç§°">
                    <button id="addSpeciesBtn" class="primary-btn">æ·»åŠ </button>
                </div>
                <div class="species-list" id="speciesList">
                    <!-- åŠ¨æ€æ’å…¥ç‰©ç§é¢„è­¦é¡¹ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è­¦é€šçŸ¥å¼¹çª— -->
<div id="alertNotification" class="alert-notification">
    <div class="alert-notification-content">
        <div class="alert-header">
            <span class="alert-icon">âš ï¸</span>
            <span class="alert-title">é¢„è­¦é€šçŸ¥</span>
            <span class="close-alert" onclick="closeAlertNotification()">&times;</span>
        </div>
        <div class="alert-message" id="alertNotificationMessage"></div>
        <div class="alert-time" id="alertNotificationTime"></div>
    </div>
</div>

<!-- æ•°æ®çœ‹æ¿å¼¹çª— -->
<div id="dashboardPopup" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closePopup('dashboardPopup')">&times;</span>
        <h2>ğŸ“Š æ•°æ®çœ‹æ¿</h2>
        <div class="dashboard-stats">
            <div class="stat-card">
                <h3>æ€»è¯†åˆ«æ•°</h3>
                <p id="totalCount">0</p>
            </div>
            <div class="stat-card">
                <h3>ä»Šæ—¥è¯†åˆ«æ•°</h3>
                <p id="todayCount">0</p>
            </div>
            <div class="stat-card">
                <h3>æ€»é¢„è­¦æ•°</h3>
                <p id="warningCount">0</p>
            </div>
            <div class="stat-card">
                <h3>ä»Šæ—¥é¢„è­¦æ•°</h3>
                <p id="todayWarningCount">0</p>
            </div>
            <div class="stat-card">
                <h3>é—®ç­”æ¬¡æ•°</h3>
                <p id="qaCount">0</p>
            </div>
        </div>
        <div class="chart-container">
            <h3>è¯†åˆ«è¶‹åŠ¿</h3>
            <div id="chart-placeholder" class="chart-area"></div>
        </div>
    </div>
</div>

<footer class="fact-container">
    <p id="factBox">æ­£åœ¨åŠ è½½è¶£é—»...</p>
</footer>

<script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script type="module">
    let socket = null;
    let mediaRecorder = null;

    const recordBtn = document.getElementById("recordBtn");
    const outputDom = document.getElementById("chatBox");


    const appendText = (text) => {
        const p = document.createElement("p");
        p.textContent = "ğŸ—£ " + text;
        outputDom.appendChild(p);
        outputDom.scrollTop = outputDom.scrollHeight;
    };

    const startRecording = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
                channelCount: 1,
                sampleRate: 16000
            }
        });

        socket = new WebSocket("ws://localhost:8000/ws/speech");

        socket.onopen = () => {
            console.log("WebSocket connected");
            appendText("ğŸ™ï¸ å¼€å§‹å½•éŸ³å¹¶è¯†åˆ«...");
        };

        socket.onmessage = (event) => {
            if (event.data) {
                appendText(event.data);
            }
        };

        socket.onclose = () => {
            console.log("WebSocket closed");
        };

        mediaRecorder = new MediaRecorder(stream, {
            mimeType: "audio/webm"
        });

        mediaRecorder.ondataavailable = async (e) => {
            if (e.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                const arrayBuffer = await e.data.arrayBuffer();
                socket.send(arrayBuffer);
            }
        };

        mediaRecorder.start(250);
    };

    const stopRecording = () => {
        mediaRecorder.stop();
        socket.close();
        appendText("ğŸ›‘ è¯†åˆ«ç»“æŸ");
    };

    let isRecording = false;

    recordBtn.onclick = () => {
        if (!isRecording) {
            startRecording();
            recordBtn.textContent = "â¹ï¸";
        } else {
            stopRecording();
            recordBtn.textContent = "ğŸ¤";
        }
        isRecording = !isRecording;
    };

    async function loadHistory() {
        try {
            const response = await fetch('/yolo/history');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const history = await response.json();
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = ''; // Clear existing content
            
            history.forEach(record => {
                const row = document.createElement('tr');
                const date = new Date(record.created_at).toLocaleString();
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${record.detected_objects.join(', ')}</td>
                    <td>
                        ${record.image_id ? `<button onclick="viewImage(${record.image_id})">æŸ¥çœ‹å›¾ç‰‡</button>` : ''}
                        ${record.frame_id ? `<button onclick="viewFrame(${record.frame_id})">æŸ¥çœ‹å¸§</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Failed to load history:', error);
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="3">åŠ è½½å†å²è®°å½•å¤±è´¥</td></tr>';
        }
    }

    async function viewImage(imageId) {
        try {
            const response = await fetch(`/yolo/download/${imageId}`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error('Failed to view image:', error);
        }
    }

    async function viewFrame(frameId) {
        try {
            const response = await fetch(`/yolo/download/video/${frameId}`);
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error('Failed to view frame:', error);
        }
    }

    // Make functions globally available
    window.loadHistory = loadHistory;
    window.viewImage = viewImage;
    window.viewFrame = viewFrame;

    // Update the openPopup function
    window.openPopup = function(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.style.display = 'flex'; // ä½¿ç”¨flexå¸ƒå±€æ›¿ä»£blockï¼Œç¡®ä¿å±…ä¸­
            if (popupId === 'historyPopup') {
                loadHistory();
            } else if (popupId === 'dashboardPopup') {
                loadDashboardStats();
            }
        }
    };

    window.closePopup = function(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.style.display = 'none';
        }
    };

    // åŠ è½½æ•°æ®çœ‹æ¿ç»Ÿè®¡ä¿¡æ¯
    async function loadDashboardStats() {
        try {
            const response = await fetch('/yolo/stats');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const stats = await response.json();
            
            // ä»APIè·å–æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬é¢„è­¦æ•°
            document.getElementById("totalCount").textContent = stats.total || 0;
            document.getElementById("todayCount").textContent = stats.today || 0;
            document.getElementById("warningCount").textContent = stats.warnings || 0;
            document.getElementById("todayWarningCount").textContent = stats.today_warnings || 0;
            document.getElementById("qaCount").textContent = stats.qa_count || 0;
            
            // æ¸²æŸ“è¯†åˆ«è¶‹åŠ¿å›¾è¡¨
            const chartPlaceholder = document.getElementById('chart-placeholder');
            if (stats.detection_trend && stats.detection_trend.length > 0) {
                renderSimpleChart(stats.detection_trend, chartPlaceholder);
            } else {
                chartPlaceholder.innerHTML = 'æš‚æ— è¯†åˆ«è¶‹åŠ¿æ•°æ®';
            }
        } catch (error) {
            console.error('Failed to load dashboard stats:', error);
            document.getElementById("totalCount").textContent = '-';
            document.getElementById("todayCount").textContent = '-';
            document.getElementById("warningCount").textContent = '-';
            document.getElementById("todayWarningCount").textContent = '-';
            document.getElementById("qaCount").textContent = '-';
            document.getElementById('chart-placeholder').innerHTML = 'åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥';
        }
    }
    
    // æ¸²æŸ“é¢„è­¦è¶‹åŠ¿å›¾è¡¨
    function renderAlertTrend() {
        const alertHistory = JSON.parse(localStorage.getItem('alertHistory') || '[]');
        const alertChart = document.getElementById('alert-chart');
        
        if (alertHistory.length === 0) {
            alertChart.innerHTML = '<div class="no-data">æš‚æ— é¢„è­¦è¶‹åŠ¿æ•°æ®</div>';
            return;
        }
        
        // æŒ‰æ—¥æœŸåˆ†ç»„å¹¶è®¡ç®—æ¯æ—¥é¢„è­¦æ¬¡æ•°
        const alertsByDate = {};
        alertHistory.forEach(alert => {
            if (!alertsByDate[alert.date]) {
                alertsByDate[alert.date] = 0;
            }
            alertsByDate[alert.date]++;
        });
        
        // è½¬æ¢æˆæ•°ç»„ï¼Œç”¨äºå›¾è¡¨æ¸²æŸ“
        const trendData = Object.keys(alertsByDate).map(date => ({
            date: date,
            count: alertsByDate[date]
        }));
        
        // æ’åºï¼Œç¡®ä¿æŒ‰æ—¥æœŸé¡ºåºæ˜¾ç¤º
        trendData.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // åªæ˜¾ç¤ºæœ€è¿‘7å¤©çš„æ•°æ®
        const recentTrendData = trendData.slice(-7);
        
        // ä½¿ç”¨ç›¸åŒçš„å›¾è¡¨æ¸²æŸ“å‡½æ•°
        renderSimpleChart(recentTrendData, alertChart);
    }
    
    // æ¸²æŸ“ç‰©ç§é¢„è­¦ç»Ÿè®¡
    function renderSpeciesAlertStats() {
        const alertHistory = JSON.parse(localStorage.getItem('alertHistory') || '[]');
        const statsContainer = document.getElementById('species-alerts-stats');
        
        if (alertHistory.length === 0) {
            statsContainer.innerHTML = '<div class="no-data">æš‚æ— ç‰©ç§é¢„è­¦æ•°æ®</div>';
            return;
        }
        
        // ç»Ÿè®¡æ¯ä¸ªç‰©ç§çš„é¢„è­¦æ¬¡æ•°
        const speciesCount = {};
        alertHistory.forEach(alert => {
            if (alert.species) {
                if (!speciesCount[alert.species]) {
                    speciesCount[alert.species] = 0;
                }
                speciesCount[alert.species]++;
            }
        });
        
        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ¬¡æ•°æ’åº
        const speciesData = Object.keys(speciesCount).map(species => ({
            species: species,
            count: speciesCount[species]
        })).sort((a, b) => b.count - a.count);
        
        // åˆ›å»ºç‰©ç§é¢„è­¦ç»Ÿè®¡è¡¨æ ¼
        let tableHtml = `
            <table class="species-stats-table">
                <thead>
                    <tr>
                        <th>ç‰©ç§</th>
                        <th>é¢„è­¦æ¬¡æ•°</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        speciesData.forEach(item => {
            tableHtml += `
                <tr>
                    <td>${item.species}</td>
                    <td>${item.count}</td>
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        statsContainer.innerHTML = tableHtml;
    }

    const ws_url = "ws://localhost:8000/ws/speech";

    // åˆå§‹åŒ–ç‰©ç§é¢„è­¦åˆ—è¡¨
    let alertSpecies = JSON.parse(localStorage.getItem('alertSpecies') || '[]');
    
    // æ·»åŠ ç‰©ç§é¢„è­¦
    function addSpeciesAlert() {
        const speciesInput = document.getElementById('speciesInput');
        const species = speciesInput.value.trim();
        
        if (species && !alertSpecies.includes(species)) {
            alertSpecies.push(species);
            localStorage.setItem('alertSpecies', JSON.stringify(alertSpecies));
            updateSpeciesList();
            speciesInput.value = '';
        }
    }
    
    // åˆ é™¤ç‰©ç§é¢„è­¦
    function removeSpeciesAlert(species) {
        alertSpecies = alertSpecies.filter(item => item !== species);
        localStorage.setItem('alertSpecies', JSON.stringify(alertSpecies));
        updateSpeciesList();
    }
    
    // æ›´æ–°ç‰©ç§åˆ—è¡¨æ˜¾ç¤º
    function updateSpeciesList() {
        const speciesList = document.getElementById('speciesList');
        speciesList.innerHTML = '';
        
        if (alertSpecies.length === 0) {
            speciesList.innerHTML = '<div class="empty-list">æš‚æ— ç‰©ç§é¢„è­¦</div>';
            return;
        }
        
        alertSpecies.forEach(species => {
            const item = document.createElement('div');
            item.className = 'species-item';
            item.innerHTML = `
                <span>${species}</span>
                <button class="delete-btn" onclick="removeSpeciesAlert('${species}')">Ã—</button>
            `;
            speciesList.appendChild(item);
        });
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘ç‰©ç§é¢„è­¦
    function checkSpeciesAlert(detectedObjects) {
        if (!alertSpecies.length) return false;
        
        for (const obj of detectedObjects) {
            if (alertSpecies.includes(obj)) {
                createAlert(`å‘ç°é¢„è­¦ç‰©ç§: ${obj}`);
                return true;
            }
        }
        return false;
    }
    
    // æ£€æŸ¥è§†é¢‘ä¼šè¯ä¸­çš„ç‰©ç§é¢„è­¦ï¼ˆæ¯ä¸ªç‰©ç§åœ¨ä¸€æ¬¡è§†é¢‘å¤„ç†ä¸­åªé¢„è­¦ä¸€æ¬¡ï¼‰
    function checkVideoSessionAlert(detectedObjects) {
        if (!alertSpecies.length) return false;
        
        // å¦‚æœä¸å­˜åœ¨ä¼šè¯é¢„è­¦é›†åˆï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
        if (!window.videoSessionAlerts) {
            window.videoSessionAlerts = new Set();
        }
        
        let hasNewAlert = false;
        
        for (const obj of detectedObjects) {
            // åªæœ‰å½“ç‰©ç§åœ¨é¢„è­¦åˆ—è¡¨ä¸­ä¸”å°šæœªåœ¨æœ¬æ¬¡ä¼šè¯ä¸­é¢„è­¦è¿‡æ—¶æ‰è§¦å‘
            if (alertSpecies.includes(obj) && !window.videoSessionAlerts.has(obj)) {
                createAlert(`å‘ç°é¢„è­¦ç‰©ç§: ${obj}`);
                // å°†æ­¤ç‰©ç§æ·»åŠ åˆ°å·²é¢„è­¦é›†åˆä¸­
                window.videoSessionAlerts.add(obj);
                hasNewAlert = true;
                
                console.log(`å·²ä¸ºç‰©ç§ ${obj} è§¦å‘ä¸€æ¬¡é¢„è­¦ï¼Œæ­¤æ¬¡è§†é¢‘ä¼šè¯ä¸­ä¸ä¼šå†æ¬¡ä¸ºæ­¤ç‰©ç§é¢„è­¦`);
            }
        }
        
        return hasNewAlert;
    }
    
    // åˆ›å»ºé¢„è­¦ä¿¡æ¯ - æ›´æ–°ä¸ºæ˜¾ç¤ºå¼¹çª—é¢„è­¦
    function createAlert(message) {
        const alertNotification = document.getElementById('alertNotification');
        const alertMessage = document.getElementById('alertNotificationMessage');
        const alertTime = document.getElementById('alertNotificationTime');
        
        const now = new Date();
        const timeString = now.toLocaleString();
        
        alertMessage.textContent = message;
        alertTime.textContent = timeString;
        
        // æ˜¾ç¤ºé¢„è­¦å¼¹çª—
        alertNotification.style.display = 'block';
        
        // 5ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(() => {
            closeAlertNotification();
        }, 5000);

        // æ’­æŠ¥é¢„è­¦ä¿¡æ¯
        speakAlertMessage(message);
        
        // å°†é¢„è­¦ä¿å­˜åˆ°æ•°æ®åº“
        saveAlertToDatabase(message);
        
        // è®°å½•åˆ°æ§åˆ¶å°ä»¥ä¾¿è°ƒè¯•
        console.log("æ˜¾ç¤ºé¢„è­¦:", message);
    }
    
    // å°†é¢„è­¦ä¿å­˜åˆ°æ•°æ®åº“
    async function saveAlertToDatabase(message) {
        // æå–ç‰©ç§åç§°
        let speciesName = "";
        if (message.includes("å‘ç°é¢„è­¦ç‰©ç§:")) {
            speciesName = message.split("å‘ç°é¢„è­¦ç‰©ç§:")[1].trim();
        }
        
        try {
            // å‘åç«¯APIå‘é€é¢„è­¦æ•°æ®
            const response = await fetch('/yolo/alert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    species: speciesName,
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`ä¿å­˜é¢„è­¦å¤±è´¥: ${response.status}`);
            }
            
            // ä¹Ÿå­˜å…¥æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
            saveAlertToLocalStorage(message, speciesName);
            
            // è®°å½•æˆåŠŸä¿¡æ¯
            console.log("é¢„è­¦å·²ä¿å­˜åˆ°æ•°æ®åº“");
        } catch (error) {
            console.error("ä¿å­˜é¢„è­¦æ•°æ®å¤±è´¥:", error);
            // å‡ºé”™æ—¶ä»ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveAlertToLocalStorage(message, speciesName);
        }
    }
    
    // ä¿å­˜é¢„è­¦æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
    function saveAlertToLocalStorage(message, speciesName) {
        // è·å–å½“å‰çš„é¢„è­¦å†å²æ•°æ®
        const alertHistory = JSON.parse(localStorage.getItem('alertHistory') || '[]');
        
        // åˆ›å»ºæ–°çš„é¢„è­¦è®°å½•
        const newAlert = {
            message: message,
            species: speciesName || "",
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString()
        };
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        alertHistory.push(newAlert);
        
        // æœ€å¤šä¿å­˜æœ€è¿‘100æ¡è®°å½•
        if (alertHistory.length > 100) {
            alertHistory.shift(); // ç§»é™¤æœ€æ—§çš„è®°å½•
        }
        
        // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
        localStorage.setItem('alertHistory', JSON.stringify(alertHistory));
    }
    
    // æ›´æ–°é¢„è­¦è®¡æ•°å™¨ - ä¸å†éœ€è¦ï¼Œæ•°æ®ä»åç«¯è·å–
    
    // è¯­éŸ³æ’­æŠ¥é¢„è­¦ä¿¡æ¯
    function speakAlertMessage(message) {
        if ('speechSynthesis' in window) {
            // åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = 'zh-CN';
            utterance.rate = 1.0;  // è¯­é€Ÿç¨æ…¢ï¼Œç¡®ä¿æ¸…æ™°
            utterance.pitch = 1.1; // ç¨é«˜çš„éŸ³è°ƒï¼Œè¡¨ç¤ºè­¦ç¤º
            utterance.volume = 1.0; // æœ€å¤§éŸ³é‡
            
            // é¢„è­¦æ’­æŠ¥ä½¿ç”¨ä¼˜å…ˆçº§
            utterance.onstart = () => {
                console.log("é¢„è­¦è¯­éŸ³æ’­æŠ¥å¼€å§‹");
            };
            
            utterance.onend = () => {
                console.log("é¢„è­¦è¯­éŸ³æ’­æŠ¥ç»“æŸ");
            };
            
            utterance.onerror = (e) => {
                console.error("é¢„è­¦è¯­éŸ³æ’­æŠ¥é”™è¯¯:", e);
            };
            
            window.speechSynthesis.speak(utterance);
        }
    }
    
    // å…³é—­é¢„è­¦é€šçŸ¥
    function closeAlertNotification() {
        const alertNotification = document.getElementById('alertNotification');
        
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
        alertNotification.style.animation = 'fadeOut 0.5s ease-out';
        
        // åŠ¨ç”»ç»“æŸåéšè—
        setTimeout(() => {
            alertNotification.style.display = 'none';
            alertNotification.style.animation = 'slideIn 0.5s ease-out';
        }, 500);
    }
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–ç‰©ç§åˆ—è¡¨
        updateSpeciesList();
        
        // æ·»åŠ ç‰©ç§æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const addSpeciesBtn = document.getElementById('addSpeciesBtn');
        if (addSpeciesBtn) {
            addSpeciesBtn.addEventListener('click', addSpeciesAlert);
        }
        
        // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        const speciesInput = document.getElementById('speciesInput');
        if (speciesInput) {
            speciesInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSpeciesAlert();
                }
            });
        }
    });
    
    // å°†å‡½æ•°æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ
    window.removeSpeciesAlert = removeSpeciesAlert;
    window.closeAlertNotification = closeAlertNotification;
    window.checkSpeciesAlert = checkSpeciesAlert;
    window.checkVideoSessionAlert = checkVideoSessionAlert;
    window.createAlert = createAlert;
    window.speakAlertMessage = speakAlertMessage;

    // ç®€å•å›¾è¡¨æ¸²æŸ“å‡½æ•°
    function renderSimpleChart(data, container) {
        // ç”Ÿæˆç®€å•çš„å›¾è¡¨
        container.innerHTML = '';
        
        // ç¡®ä¿æœ‰æ•°æ®
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="no-data">æš‚æ— å›¾è¡¨æ•°æ®</div>';
            return;
        }
        
        // æ‰¾å‡ºæœ€å¤§å€¼ç”¨äºç¼©æ”¾
        const maxValue = Math.max(...data.map(item => item.count)) || 1;
        
        // åˆ›å»ºYè½´åˆ»åº¦
        const yAxisTickCount = 5; // çºµè½´åˆ»åº¦æ•°é‡
        const yAxisTicks = [];
        for (let i = 0; i <= yAxisTickCount; i++) {
            const value = Math.round(maxValue * (yAxisTickCount - i) / yAxisTickCount);
            yAxisTicks.push(value);
        }
        
        // åˆ›å»ºYè½´HTML
        const yAxisHtml = `
            <div class="y-axis">
                ${yAxisTicks.map(tick => `<div class="y-axis-tick">${tick}</div>`).join('')}
            </div>
        `;
        
        // å›¾è¡¨æŸ±çŠ¶æ¡
        const chartBars = data.map(item => {
            const height = Math.max((item.count / maxValue * 100), 3); // è‡³å°‘3%çš„é«˜åº¦ï¼Œä»¥ä¾¿çœ‹åˆ°
            return `<div class="chart-bar" style="height:${height}%" title="${item.date}: ${item.count}æ¬¡"></div>`;
        }).join('');
        
        // åˆ›å»ºæŸ±çŠ¶å›¾å®¹å™¨
        const chartHtml = `<div class="simple-chart">${chartBars}</div>`;
        
        // åˆ›å»ºæ—¥æœŸæ ‡ç­¾
        const labelsHtml = `
            <div class="chart-labels">
                ${data.map(item => `<div class="chart-label">${item.date}</div>`).join('')}
            </div>
        `;
        
        // ç»„åˆæ‰€æœ‰å…ƒç´ 
        container.innerHTML = `
            <div class="chart-wrapper">
                ${yAxisHtml}
                ${chartHtml}
                ${labelsHtml}
            </div>
        `;
        
        // æ§åˆ¶å°è¾“å‡ºæ•°æ®ï¼Œæ–¹ä¾¿è°ƒè¯•
        console.log("å›¾è¡¨æ•°æ®:", data);
    }
</script>

</body>
</html>